<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>EEG BCI Page-Turner – Local UI</title>
    <link rel="stylesheet" href="Stim.css?v=20251122-6" />
  </head>
  <body>
    <div class="app-shell">
      <!-- Left: status + config -->
      <aside class="sidebar">
        <header class="app-header">
          <h2>The Brain-Controlled Page-Turner</h2>
          <p class="subtitle">Using EEG signals to turn the pages of a book</p>
        </header>

        <section class="status-card">
          <div id="connection-status" class="status-pill">
            <span class="dot"></span>
            <span id="connection-label">Disconnected</span>
          </div>
          <div class="status-row">
            <span class="label">Monitor refresh</span>
            <span id="refresh-label" class="value">Measuring…</span>
          </div>
          <div class="status-row">
            <span class="label">Current State</span>
            <span id="status-ui-state" class="value">—</span>
          </div>
          <div class="status-row">
            <span class="label">Active User</span>
            <span id="status-active-subject" class="value">—</span>
          </div>
          <div class="status-row">
            <span class="label">Model</span>
            <span id="status-model" class="value">—</span>
          </div>
        </section>

        <section class="controls-card">
          <h3>Session Controls</h3>
          <div class="button-row">
            <button id="btn-start-calib" class="btn ghost">Calibration</button>
            <button id="btn-start-run" class="btn primary">Run Mode</button>
            <button id="btn-start-hw" class="btn ghost">Hardware Setup</button>
          </div>
        </section>
      </aside>

      <!-- Right: main view area -->
      <main class="main-panel">
        <!-- Full-screen exit button (shown in calib/run) -->
        <button id="btn-exit" class="btn exit-btn hidden" type="button">
          Exit Session
        </button>
        <!-- main VIEW STACK (fills most of the right side) -->
        <div class="view-stack">
          <!-- HOME VIEW -->
          <section id="view-home" class="view">
            <h2>Welcome,</h2>
            <p class="view-lead">
              Choose how you want to use the EEG page-turner today.
            </p>

            <div class="home-actions">
              <div class="home-card">
                <h2>1: Calibration</h2>
                <p>
                  For new users or when you adjust the headset. Runs
                  single-frequency blocks to train a personalized SSVEP
                  classifier.
                </p>
                <span class="home-tag">Recommended first time</span>
              </div>

              <div class="home-card">
                <h2>2: Run Mode</h2>
                <p>
                  Uses the latest trained model. Look at the left or right arrow
                  to turn pages hands-free.
                </p>
                <span class="home-tag">Requires trained model</span>
              </div>

              <div class="home-card">
                <h2>3: Hardware Setup</h2>
                <p>
                  Opens the live EEG view so you can verify electrode contact
                  and channel quality before starting a session.
                </p>
                <span class="home-tag">Live signal viewer</span>
              </div>
            </div>

            <p class="home-tip">
              Tip: run <strong>Hardware Setup</strong> first, then do
              <strong>Calibration</strong>, and finally start
              <strong>Run Mode</strong>
              once you’re happy with the signals.
            </p>
          </section>

          <!-- INSTRUCTIONS VIEW -->
          <section id="view-instructions" class="view hidden">
            <h2>Instructions</h2>
            <p id="instructions-text" class="view-lead">
              Rest for a few seconds, then focus on the indicated flicker block.
            </p>
            <div class="inline-stats">
              <div>
                <span class="label">Block</span>
                <span id="instr-block-id" class="value">—</span>
              </div>
              <div>
                <span class="label">Upcoming frequency</span>
                <span id="instr-freq-hz" class="value">— Hz</span>
              </div>
            </div>
          </section>

          <!-- ACTIVE CALIBRATION VIEW -->
          <section id="view-active-calib" class="view hidden">
            <h2>Calibration Block</h2>
            <p class="view-lead">
              Focus your gaze on the flickering square to record your SSVEP
              responses.
            </p>
            <div class="flicker-stage">
              <div id="calib-block" class="flicker-block"></div>
            </div>
          </section>

          <!-- ACTIVE RUN VIEW -->
          <section id="view-active-run" class="view hidden">
            <h2>Page Turning</h2>
            <p class="view-lead">
              Look at the left or right arrow to turn pages backward or forward.
            </p>
            <div class="flicker-stage dual">
              <div id="left-arrow" class="flicker-block arrow-left">←</div>
              <div id="right-arrow" class="flicker-block arrow-right">→</div>
            </div>
          </section>

          <!-- RUN OPTIONS VIEW (START DEFAULT OR SEE PREV SESSIONS) -->
          <section id="view-run-options" class="view hidden">
            <h2>Run Options</h2>
            <p class="view-lead">
              Welcome back, <span id="run-welcome-name">friend</span>. Choose
              how you want to start the session.
            </p>

            <div class="inline-stats">
              <div>
                <span class="label">Last trained subject</span>
                <span id="run-last-subject" class="value">—</span>
              </div>
              <div>
                <span class="label">Model status</span>
                <span id="run-model-status" class="value">—</span>
              </div>
            </div>

            <div class="button-row" style="margin-top: 14px">
              <button id="btn-run-start-default" class="btn primary">
                Start with latest model
              </button>
              <button id="btn-run-saved-sessions" class="btn ghost">
                Choose saved session…
              </button>
            </div>
          </section>

          <!-- CALIB OPTIONS VIEW -->
          <section id="view-calib-options" class="view hidden">
            <div class="card">
              <h2>Calibration Setup</h2>
              <p class="muted">
                New user? Start here. Please enter your name and confirm you can
                safely view flickering stimuli. If you are photosensitive, but
                tolerant to higher frequencies, the app can still be run at
                higher frequencies, but might not work as well.
              </p>

              <label class="field">
                <span>Name</span>
                <input
                  id="calib-name"
                  type="text"
                  placeholder="e.g., khalil"
                  autocomplete="off"
                />
              </label>

              <label class="field">
                <span>Epilepsy / Photosensitivity risk</span>
                <select id="calib-epilepsy">
                  <option value="4">Select…</option>
                  <option value="0">No known risk</option>
                  <option value="1">
                    At risk, but tolerant to high frequency
                  </option>
                  <option value="2">At risk (do not proceed)</option>
                  <option value="3">Unsure</option>
                </select>
              </label>

              <div class="row">
                <button id="btn-calib-back" class="btn secondary">Back</button>
                <button id="btn-calib-submit" class="btn primary">
                  Start Calibration
                </button>
              </div>
            </div>
          </section>

          <!-- SESSIONS PAGE VIEW -->
          <section id="view-saved-sessions" class="view hidden">
            <h2>Saved Sessions</h2>
            <p class="view-lead">
              Select a previous session to load its trained model, or start a
              new one.
            </p>

            <!-- Placeholder list; filled from GET /state as calib sessions are run -->
            <!-- will be made clickable in css -->
            <div id="sessions-empty" class="label" style="margin-bottom: 8px">
              No saved sessions yet.
            </div>
            <ul id="sessions-list" class="sessions-list">
              <!-- <li> items injected by JS -->
            </ul>

            <div class="button-row" style="margin-top: 14px">
              <button id="btn-sessions-new" class="btn primary">
                Start new session
              </button>
              <button id="btn-sessions-back" class="btn ghost">
                Back to run options
              </button>
            </div>
          </section>
        </div>

        <!-- HARDWARE CHECKS VIEW -->
        <section id="view-hardware-checks" class="view hidden">
          <h2>Hardware Setup & Signal Quality Checker</h2>
          <br />
          <p class="view-lead">
            Verify headset placement and electrode contact by inspecting
            per-channel signal quality indicators and live EEG trace.
          </p>
          <br />
          <!-- Quality indicators row -->
          <!-- Health header -->
          <div class="hw-health">
            <div class="hw-health-left">
              <div id="hw-health-badge" class="hw-health-badge good">
                <span class="dot"></span>
                <div class="txt">
                  <div class="title">Signal Health</div>
                  <div id="hw-health-label" class="sub">—</div>
                </div>
              </div>

              <div class="hw-health-meta">
                <div class="meta-item">
                  <div class="k">Rolling Bad Windows</div>
                  <div id="hw-roll-bad" class="v">—%</div>
                </div>
                <div class="meta-item">
                  <div class="k">Overall Bad Windows</div>
                  <div id="hw-overall-bad" class="v">—%</div>
                </div>
                <div class="meta-item">
                  <div class="k">Number of Windows in Rolling</div>
                  <div id="hw-roll-n" class="v">—</div>
                </div>
              </div>
            </div>

            <div class="hw-health-right">
              <div class="hw-health-hint">
                Green = stable signal. Yellow = borderline. Red = too many
                artifact windows.
              </div>
            </div>
          </div>

          <!-- Scrollable container with stacked channel plots -->
          <div id="hw-plots-container" class="hw-plots-container">
            <!-- channel canvases will be injected by JS -->
          </div>
        </section>

        <!-- MODAL OVERLAY (popups) -->
        <div id="modal-backdrop" class="modal-backdrop hidden">
          <div class="modal">
            <h3 id="modal-title">Notice</h3>
            <p id="modal-body">
              You must complete at least one calibration session before starting
              run mode.
            </p>
            <div class="button-row" style="margin-top: 10px">
              <button id="modal-ok" class="btn primary">OK</button>
              <button id="modal-cancel" class="btn ghost hidden">Cancel</button>
            </div>
          </div>
        </div>

        <!-- LOG PANEL (small strip at the bottom) -->
        <section class="log-panel">
          <h3>Event Log</h3>
          <div id="log" class="log-body"></div>
        </section>
      </main>
    </div>

    <!-- Local Chart.js (open src lib)) -->
    <script src="lib/chart.umd.min.js"></script>
    <!-- Main script -->
    <script src="Stim.js?v=20251119-12"></script>
  </body>
</html>
