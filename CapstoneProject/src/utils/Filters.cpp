#include "Filters.hpp"

// from FilterDesign.py
static constexpr float fir_blackman_201_b[201] = {
    8.6551515e-35f, -1.3211498e-07f, -8.11674399e-07f, -1.53406191e-06f, -5.02471764e-07f,
    4.41199228e-06f, 1.39520925e-05f, 2.60886511e-05f, 3.61068915e-05f, 3.86300447e-05f,
    3.09207104e-05f, 1.58025434e-05f, 2.28147186e-06f, 2.72994489e-06f, 2.71287165e-05f,
    7.66380323e-05f, 0.000139769801f, 0.000193945057f, 0.000213158672f, 0.00017953563f,
    9.40410095e-05f, -1.91461364e-05f, -0.000118303948f, -0.000159599438f, -0.000117249611f,
    1.41624024e-18f, 0.000144614592f, 0.000242903137f, 0.000222385867f, 4.45158019e-05f,
    -0.000270970675f, -0.000642720721f, -0.000951065861f, -0.001082683f, -0.000980811531f,
    -0.000679854015f, -0.000306296092f, -3.95496736e-05f, -4.28298808e-05f, -0.000389028796f,
    -0.00101292619f, -0.00171479811f, -0.00222227038f, -0.00229318248f, -0.00182184424f,
    -0.000903791558f, 0.000174898184f, 0.00103050147f, 0.00132945474f, 0.000936421122f,
    -2.12047594e-18f, -0.00106899907f, -0.00173268501f, -0.00153356578f, -0.000297268541f,
    0.00175500669f, 0.00404334814f, 0.00581965109f, 0.00645253428f, 0.00570042349f, 0.00385796963f,   
    0.00169909731f, 0.000214709923f, 0.000227812372f, 0.00202962345f, 0.00518911352f, 0.00863550395f, 
    0.0110131323f, 0.0111963656f, 0.0087733976f, 0.00429781967f, -0.000822259404f, -0.00479573198f,   
    -0.0061323167f, -0.00428702868f, 4.82441573e-18f, 0.00484211751f, 0.00782527937f, 0.00691772834f, 
    0.0013418742f, -0.007943969f, -0.0183940117f, -0.0266742369f, -0.029880686f, -0.0267537592f,      
    -0.0184155184f, -0.00828205558f, -0.00107369942f, -0.00117509047f, -0.0108681149f,
    -0.0290679273f, -0.0510817467f, -0.069602784f, -0.0767412588f, -0.0665182618f, -0.0370404445f,    
    0.00838273887f, 0.0616223452f, 0.111597495f, 0.147134505f, 0.159990226f, 0.147134505f,
    0.111597495f, 0.0616223452f, 0.00838273887f, -0.0370404445f, -0.0665182618f, -0.0767412588f,      
    -0.069602784f, -0.0510817467f, -0.0290679273f, -0.0108681149f, -0.00117509047f, -0.00107369942f,  
    -0.00828205558f, -0.0184155184f, -0.0267537592f, -0.029880686f, -0.0266742369f, -0.0183940117f,   
    -0.007943969f, 0.0013418742f, 0.00691772834f, 0.00782527937f, 0.00484211751f, 4.82441573e-18f,    
    -0.00428702868f, -0.0061323167f, -0.00479573198f, -0.000822259404f, 0.00429781967f,
    0.0087733976f, 0.0111963656f, 0.0110131323f, 0.00863550395f, 0.00518911352f, 0.00202962345f,      
    0.000227812372f, 0.000214709923f, 0.00169909731f, 0.00385796963f, 0.00570042349f, 0.00645253428f, 
    0.00581965109f, 0.00404334814f, 0.00175500669f, -0.000297268541f, -0.00153356578f,
    -0.00173268501f, -0.00106899907f, -2.12047594e-18f, 0.000936421122f, 0.00132945474f,
    0.00103050147f, 0.000174898184f, -0.000903791558f, -0.00182184424f, -0.00229318248f,
    -0.00222227038f, -0.00171479811f, -0.00101292619f, -0.000389028796f, -4.28298808e-05f,
    -3.95496736e-05f, -0.000306296092f, -0.000679854015f, -0.000980811531f, -0.001082683f,
    -0.000951065861f, -0.000642720721f, -0.000270970675f, 4.45158019e-05f, 0.000222385867f,
    0.000242903137f, 0.000144614592f, 1.41624024e-18f, -0.000117249611f, -0.000159599438f,
    -0.000118303948f, -1.91461364e-05f, 9.40410095e-05f, 0.00017953563f, 0.000213158672f,
    0.000193945057f, 0.000139769801f, 7.66380323e-05f, 2.71287165e-05f, 2.72994489e-06f,
    2.28147186e-06f, 1.58025434e-05f, 3.09207104e-05f, 3.86300447e-05f, 3.61068915e-05f,
    2.60886511e-05f, 1.39520925e-05f, 4.41199228e-06f, -5.02471764e-07f, -1.53406191e-06f,
    -8.11674399e-07f, -1.3211498e-07f, 8.6551515e-35f
};

static constexpr float sg_21_3_b[21] = {
    -0.0559006211f, -0.0248447205f, 0.00294213795f, 0.0274599542f, 0.0487087283f, 0.0666884603f,      
    0.08139915f, 0.0928407976f, 0.101013403f, 0.105916966f, 0.107551487f, 0.105916966f, 0.101013403f, 
    0.0928407976f, 0.08139915f, 0.0666884603f, 0.0487087283f, 0.0274599542f, 0.00294213795f,
    -0.0248447205f, -0.0559006211f
};

EegFilterBank_C::EegFilterBank_C() {
    for (std::size_t ch = 0; ch < NUM_CH_CHUNK; ++ch) {
        bandpass_[ch].init_from_taps(fir_blackman_201_b);
        smooth_[ch].init_from_taps(sg_21_3_b);
    }
}

void EegFilterBank_C::process_chunk(bufferChunk_S& chunk) {
    constexpr std::size_t nCh = NUM_CH_CHUNK;
    constexpr std::size_t nS  = NUM_SAMPLES_CHUNK / NUM_CH_CHUNK;

    for (std::size_t s = 0; s < nS; ++s) {
        for (std::size_t ch = 0; ch < nCh; ++ch) {
            const std::size_t idx = s * nCh + ch;
            float x = chunk.data[idx];

            // 1) Bandpass (5–25 Hz)
            float y = bandpass_[ch].process(x);

            // 2) Savitzky–Golay smoothing
            y = smooth_[ch].process(y);

            chunk.data[idx] = y;
        }
    }
}
