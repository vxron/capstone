#include "Filters.hpp"
#include "../utils/Logger.hpp"

// from FilterDesign.py
static constexpr float fir_blackman_201_b[201] = {
    8.6551515e-35f, -1.3211498e-07f, -8.11674399e-07f, -1.53406191e-06f, -5.02471764e-07f,
    4.41199228e-06f, 1.39520925e-05f, 2.60886511e-05f, 3.61068915e-05f, 3.86300447e-05f,
    3.09207104e-05f, 1.58025434e-05f, 2.28147186e-06f, 2.72994489e-06f, 2.71287165e-05f,
    7.66380323e-05f, 0.000139769801f, 0.000193945057f, 0.000213158672f, 0.00017953563f,
    9.40410095e-05f, -1.91461364e-05f, -0.000118303948f, -0.000159599438f, -0.000117249611f,
    1.41624024e-18f, 0.000144614592f, 0.000242903137f, 0.000222385867f, 4.45158019e-05f,
    -0.000270970675f, -0.000642720721f, -0.000951065861f, -0.001082683f, -0.000980811531f,
    -0.000679854015f, -0.000306296092f, -3.95496736e-05f, -4.28298808e-05f, -0.000389028796f,
    -0.00101292619f, -0.00171479811f, -0.00222227038f, -0.00229318248f, -0.00182184424f,
    -0.000903791558f, 0.000174898184f, 0.00103050147f, 0.00132945474f, 0.000936421122f,
    -2.12047594e-18f, -0.00106899907f, -0.00173268501f, -0.00153356578f, -0.000297268541f,
    0.00175500669f, 0.00404334814f, 0.00581965109f, 0.00645253428f, 0.00570042349f, 0.00385796963f,   
    0.00169909731f, 0.000214709923f, 0.000227812372f, 0.00202962345f, 0.00518911352f, 0.00863550395f, 
    0.0110131323f, 0.0111963656f, 0.0087733976f, 0.00429781967f, -0.000822259404f, -0.00479573198f,   
    -0.0061323167f, -0.00428702868f, 4.82441573e-18f, 0.00484211751f, 0.00782527937f, 0.00691772834f, 
    0.0013418742f, -0.007943969f, -0.0183940117f, -0.0266742369f, -0.029880686f, -0.0267537592f,      
    -0.0184155184f, -0.00828205558f, -0.00107369942f, -0.00117509047f, -0.0108681149f,
    -0.0290679273f, -0.0510817467f, -0.069602784f, -0.0767412588f, -0.0665182618f, -0.0370404445f,    
    0.00838273887f, 0.0616223452f, 0.111597495f, 0.147134505f, 0.159990226f, 0.147134505f,
    0.111597495f, 0.0616223452f, 0.00838273887f, -0.0370404445f, -0.0665182618f, -0.0767412588f,      
    -0.069602784f, -0.0510817467f, -0.0290679273f, -0.0108681149f, -0.00117509047f, -0.00107369942f,  
    -0.00828205558f, -0.0184155184f, -0.0267537592f, -0.029880686f, -0.0266742369f, -0.0183940117f,   
    -0.007943969f, 0.0013418742f, 0.00691772834f, 0.00782527937f, 0.00484211751f, 4.82441573e-18f,    
    -0.00428702868f, -0.0061323167f, -0.00479573198f, -0.000822259404f, 0.00429781967f,
    0.0087733976f, 0.0111963656f, 0.0110131323f, 0.00863550395f, 0.00518911352f, 0.00202962345f,      
    0.000227812372f, 0.000214709923f, 0.00169909731f, 0.00385796963f, 0.00570042349f, 0.00645253428f, 
    0.00581965109f, 0.00404334814f, 0.00175500669f, -0.000297268541f, -0.00153356578f,
    -0.00173268501f, -0.00106899907f, -2.12047594e-18f, 0.000936421122f, 0.00132945474f,
    0.00103050147f, 0.000174898184f, -0.000903791558f, -0.00182184424f, -0.00229318248f,
    -0.00222227038f, -0.00171479811f, -0.00101292619f, -0.000389028796f, -4.28298808e-05f,
    -3.95496736e-05f, -0.000306296092f, -0.000679854015f, -0.000980811531f, -0.001082683f,
    -0.000951065861f, -0.000642720721f, -0.000270970675f, 4.45158019e-05f, 0.000222385867f,
    0.000242903137f, 0.000144614592f, 1.41624024e-18f, -0.000117249611f, -0.000159599438f,
    -0.000118303948f, -1.91461364e-05f, 9.40410095e-05f, 0.00017953563f, 0.000213158672f,
    0.000193945057f, 0.000139769801f, 7.66380323e-05f, 2.71287165e-05f, 2.72994489e-06f,
    2.28147186e-06f, 1.58025434e-05f, 3.09207104e-05f, 3.86300447e-05f, 3.61068915e-05f,
    2.60886511e-05f, 1.39520925e-05f, 4.41199228e-06f, -5.02471764e-07f, -1.53406191e-06f,
    -8.11674399e-07f, -1.3211498e-07f, 8.6551515e-35f
};

// THESE TAPS ARE NOT GOOD BECAUSE THEY DONT HAVE ZERO DC GAIN
static constexpr float fir_hamming_201_b[201] = {
    0.000241931009f, 5.02136622e-05f, -1.31761105e-06f, 0.000135797005f, 0.000377193862f,
    0.000558852411f, 0.00054991899f, 0.000350214392f, 0.000101717581f, -2.59763771e-06f,
    0.000142884498f, 0.000467362034f, 0.000756131565f, 0.000795795598f, 0.000537189634f,
    0.000154345372f, -5.99767023e-05f, 9.54665635e-05f, 0.000561995056f, 0.00103083674f,
    0.00114856838f, 0.000785590584f, 0.000167102353f, -0.000254618935f, -0.000122303807f,
    0.000535115033f, 0.00127382678f, 0.00152616832f, 0.00102594707f, 5.34544172e-05f,
    -0.000713945729f, -0.000678820892f, 0.000202611882f, 0.00131914614f, 0.00179941637f,
    0.00115527977f, -0.000296420987f, -0.00158648266f, -0.0017678498f, -0.000648885629f,
    0.000975062376f, 0.00182594617f, 0.00107396521f, -0.00097684496f, -0.00300263972f,
    -0.0035696041f, -0.0022225176f, 6.60788996e-05f, 0.00149603748f, 0.000734375927f,
    -0.00201854142f, -0.00503073496f, -0.00621174269f, -0.00467392244f, -0.00152605488f,
    0.000780704991f, 0.000193508334f, -0.00333958338f, -0.00763998688f, -0.00974624797f,
    -0.00809395424f, -0.00383727244f, -0.000226523066f, -0.000333484826f, -0.00469883703f,
    -0.0106815281f, -0.014163483f, -0.0125370887f, -0.00683003291f, -0.00127447281f,
    -0.000403446412f, -0.00563707751f, -0.0138947387f, -0.0194821161f, -0.0181491539f,
    -0.0104667716f, -0.0018998054f, 0.000820368752f, -0.00532735409f, -0.0169402213f, -0.0260368181f,
    -0.0255816033f, -0.01495093f, -0.00122026553f, 0.00520519551f, -0.0019483596f, -0.0194540496f,
    -0.0356017757f, -0.0377476212f, -0.0217617259f, 0.00329564933f, 0.0194554356f, 0.0114843852f,
    -0.0211122695f, -0.0599952922f, -0.0758661628f, -0.0449757984f, 0.0350676593f, 0.140088588f,
    0.228976712f, 0.263723617f, 0.228976712f, 0.140088588f, 0.0350676593f, -0.0449757984f,
    -0.0758661628f, -0.0599952922f, -0.0211122695f, 0.0114843852f, 0.0194554356f, 0.00329564933f,
    -0.0217617259f, -0.0377476212f, -0.0356017757f, -0.0194540496f, -0.0019483596f, 0.00520519551f,
    -0.00122026553f, -0.01495093f, -0.0255816033f, -0.0260368181f, -0.0169402213f, -0.00532735409f,
    0.000820368752f, -0.0018998054f, -0.0104667716f, -0.0181491539f, -0.0194821161f, -0.0138947387f,
    -0.00563707751f, -0.000403446412f, -0.00127447281f, -0.00683003291f, -0.0125370887f,
    -0.014163483f, -0.0106815281f, -0.00469883703f, -0.000333484826f, -0.000226523066f,
    -0.00383727244f, -0.00809395424f, -0.00974624797f, -0.00763998688f, -0.00333958338f,
    0.000193508334f, 0.000780704991f, -0.00152605488f, -0.00467392244f, -0.00621174269f,
    -0.00503073496f, -0.00201854142f, 0.000734375927f, 0.00149603748f, 6.60788996e-05f,
    -0.0022225176f, -0.0035696041f, -0.00300263972f, -0.00097684496f, 0.00107396521f, 0.00182594617f,
    0.000975062376f, -0.000648885629f, -0.0017678498f, -0.00158648266f, -0.000296420987f,
    0.00115527977f, 0.00179941637f, 0.00131914614f, 0.000202611882f, -0.000678820892f,
    -0.000713945729f, 5.34544172e-05f, 0.00102594707f, 0.00152616832f, 0.00127382678f,
    0.000535115033f, -0.000122303807f, -0.000254618935f, 0.000167102353f, 0.000785590584f,
    0.00114856838f, 0.00103083674f, 0.000561995056f, 9.54665635e-05f, -5.99767023e-05f,
    0.000154345372f, 0.000537189634f, 0.000795795598f, 0.000756131565f, 0.000467362034f,
    0.000142884498f, -2.59763771e-06f, 0.000101717581f, 0.000350214392f, 0.00054991899f,
    0.000558852411f, 0.000377193862f, 0.000135797005f, -1.31761105e-06f, 5.02136622e-05f,
    0.000241931009f
};

static constexpr float sg_21_3_b[21] = {
    -0.0559006211f, -0.0248447205f, 0.00294213795f, 0.0274599542f, 0.0487087283f, 0.0666884603f,      
    0.08139915f, 0.0928407976f, 0.101013403f, 0.105916966f, 0.107551487f, 0.105916966f, 0.101013403f, 
    0.0928407976f, 0.08139915f, 0.0666884603f, 0.0487087283f, 0.0274599542f, 0.00294213795f,
    -0.0248447205f, -0.0559006211f
};

static inline void log_fir_dc_gain_once(const float* b, std::size_t n, const char* name) {
    double sum = 0.0;
    double l1  = 0.0;
    double l2  = 0.0;
    for (std::size_t i = 0; i < n; ++i) {
        const double v = (double)b[i];
        sum += v;
        l1  += std::fabs(v);
        l2  += v * v;
    }
    const double l2n = std::sqrt(l2);

    LOG_ALWAYS("[FIR CHECK] " << name
              << " taps=" << n
              << " sum=" << std::setprecision(10) << sum
              << " (DC gain ~ sum)"
              << " |sum|=" << std::fabs(sum)
              << " L1=" << l1
              << " L2=" << l2n);
}

// Constructor constructs with specifically set filters (choose from above options)
EegFilterBank_C::EegFilterBank_C() {
    LOG_ALWAYS("EegFilterBank constructed");
    // One-time FIR sanity check: bandpass should have sum(b) ~ 0 (kills DC)
    static bool didCheck = false;
    if (!didCheck) {
        didCheck = true;
        log_fir_dc_gain_once(fir_hamming_201_b, 201, "fir_hamming_201_b (2-35 Hz?)");
        // optional: compare
        log_fir_dc_gain_once(fir_blackman_201_b, 201, "fir_blackman_201_b (2-35 Hz?)");
        log_fir_dc_gain_once(sg_21_3_b, 21, "sg_21_3_b (smoother)");
    }

    for (std::size_t ch = 0; ch < NUM_CH_CHUNK; ++ch) {
        bandpass_[ch].init_from_taps(fir_blackman_201_b); // currently Hamming 201 taps 2-35 Hz
        smooth_[ch].init_from_taps(sg_21_3_b);
        dc_[ch].a = 0.995f;                 // try 0.995â€“0.999
        dc_[ch].reset(0.0f);
    }
}

// Preprocessing pipeline
void EegFilterBank_C::process_chunk(bufferChunk_S& chunk) {
    constexpr std::size_t nCh = NUM_CH_CHUNK;
    constexpr std::size_t nS  = NUM_SAMPLES_CHUNK / NUM_CH_CHUNK;

    // 1) CAR
    remove_common_mode_noise(chunk);

    // 2) frequency filtering
    for (std::size_t s = 0; s < nS; ++s) {
        for (std::size_t ch = 0; ch < nCh; ++ch) {
            const std::size_t idx = s * nCh + ch;
            float x = chunk.data[idx];
            // 2a) Simple DC blocker
            x = dc_[ch].process(x);
            // 2b) Bandpass FIR
            x = bandpass_[ch].process(x);
            chunk.data[idx] = x;
        }
    }
}

// per sample cross channel mean subtraction (CAR)
void EegFilterBank_C::remove_common_mode_noise(bufferChunk_S& chunk){
    // acquire new chunk
    for(std::size_t s = 0; s < NUM_SCANS_CHUNK; s++){
        float mean = 0.0f;
        // acquire new sample
        // 1) compute per-sample mean across channels
        for(std::size_t ch = 0; ch < NUM_CH_CHUNK; ch++){
            mean += chunk.data[s*NUM_CH_CHUNK + ch];
        }
        mean /= static_cast<float>(NUM_CH_CHUNK);
        // 2) substract per-sample mean from all the channels
        for(std::size_t ch = 0; ch < NUM_CH_CHUNK; ch++){
            chunk.data[s*NUM_CH_CHUNK + ch] -= mean;
        }
    }
}

/*
void EegFilterBank_C::level_shift_and_scale(bufferChunk_S &chunk)
{
    constexpr int NUM_CH = NUM_CH_CHUNK;
    const int scansPerChunk = NUM_SAMPLES_CHUNK / NUM_CH;

    for (int ch = 0; ch < NUM_CH; ++ch) {
        double mean = 0.0;
        for (int s = ch; s < NUM_SAMPLES_CHUNK; s += NUM_CH) {
            mean += chunk.data[s];
        }
        mean /= scansPerChunk;

        for (int s = ch; s < NUM_SAMPLES_CHUNK; s += NUM_CH) {
            chunk.data[s] -= mean;
        }
    }
}
    */

